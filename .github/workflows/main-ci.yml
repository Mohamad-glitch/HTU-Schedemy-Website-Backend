name: Runs All Tests then Deploy

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Maven Package (Build JAR)




        run: mvn package -DskipTests 

      - name: Configure AWS Credentials

        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      - name: Setup Packer

        uses: hashicorp/setup-packer@main

      - name: Build AMI with Packer & Ansible

        id: packer_build
        run: |
          packer init build.pkr.hcl
          packer build -machine-readable build.pkr.hcl | tee build_output.txt
          echo "AMI_ID=$(grep 'artifact,0,id' build_output.txt | cut -d, -f6 | cut -d: -f2)" >> $GITHUB_ENV

      - name: Start Canary Deployment and Wait
        if: success() && env.AMI_ID != ''
        run: |
          # 1. Update Launch Template
@@ -56,24 +49,33 @@
            --source-version '$Latest' \
            --launch-template-data "{\"ImageId\":\"${{ env.AMI_ID }}\"}"

          # 2. Start Instance Refresh
          REFRESH_ID=$(aws autoscaling start-instance-refresh \












            --auto-scaling-group-name "final" \
            --preferences '{
              "MinHealthyPercentage": 100,
              "InstanceWarmup": 60,
              "CheckpointPercentages": [50, 100],
              "CheckpointDelay": 60
            }' --query "InstanceRefreshId" --output text)

          echo "Deployment Started. ID: $REFRESH_ID"

          # 3. Wait/Poll Loop
          while true; do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name "final" \
              --instance-refresh-ids $REFRESH_ID \
              --query "InstanceRefreshes[0].Status" --output text)

            echo "Current Status: $STATUS..."

            if [ "$STATUS" == "Successful" ]; then
              echo "Deployment Successful!"
              break
            elif [ "$STATUS" == "Failed" ] || [ "$STATUS" == "Cancelled" ]; then
              echo "Deployment $STATUS."
              exit 1
            fi
            sleep 60
          done
